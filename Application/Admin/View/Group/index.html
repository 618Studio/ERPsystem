<!DOCTYPE html>
<html lang="en">
<head>
    <!-- BEGIN META -->

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Olive Enterprise">
    <!-- END META -->

    <!-- BEGIN SHORTCUT ICON -->
    <link rel="shortcut icon" href="__ROOT__/Public/img/favicon.ico">
    <!-- END SHORTCUT ICON -->
    <title>
        群组管理 - 普林派特ERP管理系统
    </title>

    <!-- BEGIN STYLESHEET -->

    <link href="__ROOT__/Public/css/bootstrap.min.css" rel="stylesheet"><!-- BOOTSTRAP CSS -->
    <link href="__ROOT__/Public/css/bootstrap-reset.css" rel="stylesheet"><!-- BOOTSTRAP CSS -->

    <link href="__ROOT__/Public/assets/font-awesome/css/font-awesome.css" rel="stylesheet"><!-- FONT AWESOME ICON STYLESHEET -->
    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/assets/bootstrap-wysihtml5/bootstrap-wysihtml5.css"><!-- BOOTSTRAP WYSIHTML5 PLUGIN CSS -->
    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/assets/jquery-multi-select/css/multi-select.css"><!-- JQUERY MULTI SELECT PLUGIN CSS -->
    <link rel="stylesheet" href="__ROOT__/Public/assets/data-tables/DT_bootstrap.css"><!-- DATATABLE CSS -->
    <link href="__ROOT__/Public/css/style.css" rel="stylesheet"><!-- THEME BASIC CSS -->
    <link href="__ROOT__/Public/css/style-responsive.css" rel="stylesheet"><!-- THEME BASIC RESPONSIVE  CSS -->

    <!--[if lt IE 9]>
    <script src="__ROOT__/Public/js/html5shiv.js">
    </script>
    <script src="__ROOT__/Public/js/respond.min.js">
    </script>
    <![endif]-->
    <!-- END STYLESHEET -->

</head>
<body>
<!-- BEGIN SECTION -->

<section id="container" class="">
    <!-- BEGIN HEADER -->

    <include file="./Application/Common/Common/header.html" />
    <!-- END HEADER -->


    <!-- BEGIN SIDEBAR -->
    <include file="./Application/Common/Common/sidebar.html" />
    <!-- END SIDEBAR -->

    <!-- START MAIN CONTENT -->
    <section id="main-content">
        
        <section class="wrapper site-min-height">
            <!-- START ROW -->
            <div class="row">
                <div class="col-md-8">
                    <section class="panel">
                        <header class="panel-heading">
                            <span class="label label-primary">用 户 组</span>
                             <span class="tools pull-right">
                             <a href="javascript:;" class="fa fa-chevron-down"></a>
                             <a href="javascript:;" class="fa fa-times"></a>
                             </span>
                        </header>
                        <div class="panel-body">
                            <div class="adv-table editable-table ">
                                <div class="clearfix">
                                    <div class="btn-group">
                                        <button id="editable-sample_new" class="btn btn-success green">
                                            增加群组 <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group pull-right">
                                        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">工 具 <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu pull-right">
                                            <li><a href="#">Print</a></li>
                                            <li><a href="#">Save as PDF</a></li>
                                            <li><a href="#">Export to Excel</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="space15"></div>
                                <table class="table table-striped table-hover table-bordered" id="editable-sample">
                                        <thead>
                                        <tr>
                                            <th>群 组 号</th>
                                            <th>群 组 名</th>
                                            <th>编 辑</th>
                                            <th>删 除</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <volist name="group" id="vo">
                                            <tr class="">
                                                <td>{$key}</td>
                                                <td>{$vo}</td>
                                                <td><a class="edit" href="javascript:;" onclick="edit('{$key}','{$vo}')"><span class="label label-success">编 辑</span></a></td>
                                                <td><a class="delete" href="javascript:;"><span  n class="label label-danger">删 除</span></a></td>
                                            </tr>
                                        </volist>
                                        </tbody>
                                    </table>

                            </div>
                        </div>
                    </section>
                </div>
                <div class="col-md-4">
                    <section class="panel">
                        <header class="panel-heading">
                            <span class="label label-primary">
                            权 限 编 辑
                            </span>
                            <span class="tools pull-right">
                                <a href="javascript:;" class="fa fa-chevron-down">
                                </a>
                                <a href="javascript:;" class="fa fa-times">
                                </a>
                            </span>
                        </header>
                        <div class="panel-body">
                            <div style="padding-bottom: 30px"></div>
                            <form action="#" class="form-horizontal tasi-form">

                                <div class="form-group last">

                                    <div class="col-md-10 col-md-offset-1">
                                        <select name="country" class="multi-select" multiple="" id="my_multi_select3">


                                        </select>
                                    </div>
                                </div>
                            </form>
                            <div style="padding-bottom: 70px"></div>
                        </div>
                        <div class="panel-footer">
                            <h2 class="text-center" id="current_group"></h2>
                        </div>
                    </section>
                </div>
            </div>
            <!-- END ROW -->
            <div class="row"></div>


        </section>
        <!-- START WRAPPER -->
    </section>
    <!-- END MAIN CONTENT -->
    <!-- BEGIN FOOTER -->
    <include file="./Application/Common/Common/footer.html" />
    <!-- END FOOTER --> 

</section>
<!-- END SECTION -->


<!-- BEGIN JS -->

<script src="__ROOT__/Public/js/jquery-1.8.3.min.js" ></script><!-- BASIC JS LIABRARY 1.8.3 -->
<script src="__ROOT__/Public/js/bootstrap.min.js" ></script><!-- BOOTSTRAP JS  -->
<script src="__ROOT__/Public/js/jquery.dcjqaccordion.2.7.js"></script><!-- ACCORDING JS -->
<script src="__ROOT__/Public/js/jquery.scrollTo.min.js" ></script><!-- SCROLLTO JS  -->
<script src="__ROOT__/Public/js/jquery.nicescroll.js" > </script><!-- NICESCROLL JS  -->
<script src="__ROOT__/Public/js/respond.min.js" ></script><!-- RESPOND JS  -->
<script src="__ROOT__/Public/assets/jquery-multi-select/js/jquery.multi-select.js"></script><!-- BOOTSTRAP MULTISELECT JS  -->
<script src="__ROOT__/Public/assets/jquery-multi-select/js/jquery.quicksearch.js"></script><!-- BOOTSTRAP MULTISELECT JS  -->
<script src="__ROOT__/Public/assets/data-tables/jquery.dataTables.js"></script><!-- DATATABLE JS  -->
<script src="__ROOT__/Public/assets/data-tables/DT_bootstrap.js"></script><!-- DATATABLE JS  -->
<script src="__ROOT__/Public/js/common-scripts.js" ></script><!-- BASIC COMMON JS  -->
<!-- END JS -->
<script>
    $("#admin_module").addClass("active");
    $("#group_manage").addClass("active");
    var privilege = {
        gOrder: ['订单增加','订单浏览','订单修改','订单删除'],
        gMaterials: ['物资种类管理','物资入库','物资出库','仓库管理（设置）','物资查询','配件使用申请','配件使用审批','配件仓储查询'],
        gWork: ['生产计划查看','生产计划管理(增删改、审核)','领料管理(申请、审批、执行)','镀铝锌生产线运行监控','产成品下线管理','报表管理','彩涂生产线运行监控','产成品下线管理','报表管理'],
        gQualityCost: ['成本项管理','成本值采集','成本计算(公式)','成本控制','报表管理','质检通知管理','物质检验(原料、在制、成品)','不合格品管理','质量异议现场确认','质量追溯'],
        gInfo: ['报表查询按时间(一日、三日、周、月）','报表查询按产线','报表查询按订单','群组及权限管理','系统账户管理','下级账户管理','用户信息查询','用户信息修改']
    };

    //privilege.gOrder[0]
    $('#my_multi_select3').multiSelect({
        selectableHeader: "<input type='text' class='form-control search-input' autocomplete='off' placeholder='搜索...'>",
        selectionHeader: "<input type='text' class='form-control search-input' autocomplete='off' placeholder='搜索...'>",
        afterInit: function (ms) {
            var that = this,
                    $selectableSearch = that.$selectableUl.prev(),
                    $selectionSearch = that.$selectionUl.prev(),
                    selectableSearchString = '#' + that.$container.attr('id') + ' .ms-elem-selectable:not(.ms-selected)',
                    selectionSearchString = '#' + that.$container.attr('id') + ' .ms-elem-selection.ms-selected';
            that.qs1 = $selectableSearch.quicksearch(selectableSearchString).on('keydown', function (e) {
                if (e.which === 40) {
                    that.$selectableUl.focus();
                    return false;
                }
            });
            that.qs2 = $selectionSearch.quicksearch(selectionSearchString).on('keydown', function (e) {
                if (e.which == 40) {
                    that.$selectionUl.focus();
                    return false;
                }
            });
        },
        afterSelect: function () {
            this.qs1.cache();
            this.qs2.cache();
        },
        afterDeselect: function () {
            this.qs1.cache();
            this.qs2.cache();
        },
        selectableFooter: "<h4 style='text-align: center'>可选权限</h4>",
        selectionFooter: "<h4 style='text-align: center'>已有权限</h4>"

    });

    var EditableTable = function () {

        'use strict';

        return {
            init: function () {
                function restoreRow(oTable, nRow) {
                    var aData = oTable.fnGetData(nRow);
                    var jqTds = $('>td', nRow);
                    for (var i = 0, iLen = jqTds.length; i < iLen; i++) {
                        oTable.fnUpdate(aData[i], nRow, i, false);
                    }
                    oTable.fnDraw();
                }

                function editRow(oTable, nRow) {
                    var aData = oTable.fnGetData(nRow);
                    var jqTds = $('>td', nRow);
                    jqTds[0].innerHTML = '<input type="text" class="form-control small" value="' + aData[0] + '" disabled>';
                    jqTds[1].innerHTML = '<input type="text" class="form-control small" value="' + aData[1] + '">';
                    jqTds[2].innerHTML = '<a class="save" href=""><span class="label label-primary">保 存</span></a>';
                    jqTds[3].innerHTML = '<a class="cancel" href=""><span class="label label-info">取 消</span></a>';
                }

                function saveRow(oTable, nRow) {
                    var jqInputs = $('input', nRow);
                    oTable.fnUpdate(jqInputs[0].value, nRow, 0, false);
                    oTable.fnUpdate(jqInputs[1].value, nRow, 1, false);
                    oTable.fnUpdate('<a class="edit" href=""><span class="label label-success">编 辑</span></a>', nRow, 2, false);
                    oTable.fnUpdate('<a class="delete" href=""><span class="label label-danger">删 除</span></a>', nRow, 3, false);
                    oTable.fnDraw();
                }

                function cancelEditRow(oTable, nRow) {
                    var jqInputs = $('input', nRow);
                    oTable.fnUpdate(jqInputs[0].value, nRow, 0, false);
                    oTable.fnUpdate(jqInputs[1].value, nRow, 1, false);
                    oTable.fnUpdate('<a class="edit" href="">编 辑</a>', nRow, 4, false);
                    oTable.fnDraw();
                }

                var oTable = $('#editable-sample').dataTable({
                    autoWidth : false,
                    "aLengthMenu": [
                        [5, 15, 20, -1],
                        [5, 15, 20, "All"]
                    ],
                    "iDisplayLength": 5,
                    "sDom": "<'row'<'col-lg-6'l><'col-lg-6'f>r><'table-responsive' t><'row'<'col-lg-6'i><'col-lg-6'p>>",
                    "sPaginationType": "bootstrap",
                    "oLanguage": {
                        "sProcessing": "正在加载中......",
                        "sLengthMenu": "每页显示 _MENU_ 条记录",
                        "sZeroRecords": "对不起，查询不到相关数据！",
                        "sEmptyTable": "表中无数据存在！",
                        "sInfo": "当前显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
                        "sInfoFiltered": "数据表中共为 _MAX_ 条记录",
                        "sSearch": "搜索",
                        "oPaginate": {
                            "sFirst": "首页",
                            "sPrevious": "上一页",
                            "sNext": "下一页",
                            "sLast": "末页"
                        }
                    },
                    "aoColumnDefs": [{
                        'bSortable': true,
                        'aTargets': [0]
                    }]
                });
                jQuery('#editable-sample_wrapper .dataTables_filter input').addClass("form-control medium");
                jQuery('#editable-sample_wrapper .dataTables_length select').addClass("form-control xsmall");
                var nEditing = null;
                var nNew = 0;
                $('#editable-sample_new').click(function (e) {
                    e.preventDefault();
                    var aiNew = oTable.fnAddData(['', '', '<a class="edit" href="">编 辑</a>', '<a class="cancel" data-mode="new" href="">取 消</a>']);
                    var nRow = oTable.fnGetNodes(aiNew[0]);
                    var aData = oTable.fnGetData(nRow);
                    var jqTds = $('>td', nRow);
                    jqTds[0].innerHTML = '<input type="text" class="form-control small" value="' + aData[0] + '">';
                    jqTds[1].innerHTML = '<input type="text" class="form-control small" value="' + aData[1] + '">';
                    jqTds[2].innerHTML = '<a class="save" href="" data-mode="new"><span class="label label-primary">保 存</span></a>';
                    jqTds[3].innerHTML = '<a class="cancel" href="" data-mode="new"><span class="label label-info">取 消</span></a>';
                    nEditing = nRow;
                    nNew = 1;
                    for(var each1 in privilege){
                        for(var each2 in privilege[each1]) {
                            var obj = {};
                            obj.text = privilege[each1][each2];
                            obj.value = ""+row+col;
                            $('#my_multi_select3').multiSelect("addOption",obj);
                        }
                    }
                    $('#current_group').empty();
                    $('#current_group').append("<small >正 在 新 增 群 组</small>");
                });
                $('#editable-sample a.delete').live('click', function (e) {
                    e.preventDefault();
                    if (confirm("Are you sure to delete this row ?") == false) {
                        return;
                    }
                    var nRow = $(this).parents('tr')[0];
                    var jqInputs = $('td',nRow);
                    $.post("{:U('admin/group/delete')}",{
                                gId :jqInputs[0].innerHTML
                            },
                            function(data){
                                if(data['result']==1){
                                    alert("修改成功！");
                                    oTable.fnDeleteRow(nRow);
                                }
                                else if(data['result']==0){
                                    alert("修改失败！");
                                }
                            })
                });
                $('#editable-sample a.cancel').live('click', function (e) {
                    e.preventDefault();
                    if ($(this).attr("data-mode") == "new") {
                        var nRow = $(this).parents('tr')[0];
                        oTable.fnDeleteRow(nRow);
                        $('#my_multi_select3').empty();
                        $('.ms-list').empty();
                        $('#current_group').empty();
                    }
                    else {
                        restoreRow(oTable, nEditing);
                        nEditing = null;
                        $('#my_multi_select3').empty();
                        $('.ms-list').empty();
                        $('#current_group').empty();
                    }
                });
                $('#editable-sample a.edit').live('click', function (e) {
                    e.preventDefault();
                    var nRow = $(this).parents('tr')[0];
                    if (nEditing !== null && nEditing != nRow) {
                        //如果前一个是新增的
                        if(nNew){
                            oTable.fnDeleteRow(nEditing);
                            editRow(oTable, nRow);
                            nEditing = nRow;
                            nNew = 0;
                        }
                        else{
                            restoreRow(oTable, nEditing);
                            editRow(oTable, nRow);
                            nEditing = nRow;
                        }
                    } else {
                        editRow(oTable, nRow);
                        nEditing = nRow;
                    }
                });
                $('#editable-sample a.save').live('click', function (e) {
                    e.preventDefault();
                    //权限数组
                    var submit_privilege =[
                        [0,0,0,0],
                        [0,0,0,0,0,0,0,0],
                        [0,0,0,0,0,0,0,0,0],
                        [0,0,0,0,0,0,0,0,0,0],
                        [0,0,0,0,0,0,0,0]
                    ];

                    var nRow = $(this).parents('tr')[0];
                    var jqInputs = $('input', nRow);

                    var arr = $('#my_multi_select3').val();

                    if(arr!=null)
                        arr = arr.toString();
                    else
                        arr = "";

                    arr = arr.split(",");
                    for(var index in arr){
                        var row = arr[index][0];
                        var col = arr[index][1];
                        submit_privilege[row][col] = 1;
                    }

                    //将数组转换为字符串形式，用ajax发送  洪日写

                    //增加
                /*    if ($(this).attr("data-mode") == "new"){
                        $.post("{:U('admin/group/add')}",{
                                    gId: jqInputs[0].value,
                                    group_name: jqInputs[1].value,
                                    gOrderQ: privilege['gOrderQ'],
                                    gOrderE: privilege['gOrderE'],
                                    gMaterialsQ: privilege['gMaterialsQ'],
                                    gMaterialsE: privilege['gMaterialsE'],
                                    gStockQ: privilege['gStockQ'],
                                    gStockE: privilege['gStockE'],
                                    gWorkScheQ: privilege['gWorkScheQ'],
                                    gWorkScheE: privilege['gWorkScheE'],
                                    gGalQ: privilege['gGalQ'],
                                    gGalE: privilege['gGalE'],
                                    gColorQ: privilege['gColorQ'],
                                    gColorE: privilege['gColorE'],
                                    gCostQ: privilege['gCostQ'],
                                    gCostE: privilege['gCostE'],
                                    gQualityQ: privilege['gQualityQ'],
                                    gQualityE: privilege['gQualityE'],
                                    gUserQ: privilege['gUserQ'],
                                    gUserE: privilege['gUserE'],
                                },
                                function(data){
                                    if(data['result']==true){
                                        nEditing = nRow;
                                        oTable.fnUpdate(jqInputs[0].value, nRow, 0, false);
                                        oTable.fnUpdate(jqInputs[1].value, nRow, 1, false);
                                        oTable.fnUpdate('<a class="edit" href=""><span class="label label-success">编 辑</span></a>', nRow, 2, false);
                                        oTable.fnUpdate('<a class="delete" href=""><span class="label label-danger">删 除</span></a>', nRow, 3, false);
                                        restoreRow(oTable, nEditing);
                                        nEditing = null;
                                        $('#my_multi_select3').empty();
                                        $('.ms-list').empty();
                                        $('#current_group').empty();
                                        alert("增加成功！");
                                        nNew = 0;
                                    }
                                    else if(data['result']==false){
                                        alert("增加失败！");
                                    }

                                });
                    }
                    else{
                        //修改
                        $.post("{:U('admin/group/edit')}",{
                                    gId: jqInputs[0].value,
                                    group_name: jqInputs[1].value,
                                    gOrderQ: privilege['gOrderQ'],
                                    gOrderE: privilege['gOrderE'],
                                    gMaterialsQ: privilege['gMaterialsQ'],
                                    gMaterialsE: privilege['gMaterialsE'],
                                    gStockQ: privilege['gStockQ'],
                                    gStockE: privilege['gStockE'],
                                    gWorkScheQ: privilege['gWorkScheQ'],
                                    gWorkScheE: privilege['gWorkScheE'],
                                    gGalQ: privilege['gGalQ'],
                                    gGalE: privilege['gGalE'],
                                    gColorQ: privilege['gColorQ'],
                                    gColorE: privilege['gColorE'],
                                    gCostQ: privilege['gCostQ'],
                                    gCostE: privilege['gCostE'],
                                    gQualityQ: privilege['gQualityQ'],
                                    gQualityE: privilege['gQualityE'],
                                    gUserQ: privilege['gUserQ'],
                                    gUserE: privilege['gUserE'],
                                },
                                function(data){
                                    if(data['result']==true){
                                        nEditing = nRow;
                                        oTable.fnUpdate(jqInputs[0].value, nRow, 0, false);
                                        oTable.fnUpdate(jqInputs[1].value, nRow, 1, false);
                                        restoreRow(oTable, nEditing);
                                        nEditing = null;
                                        alert("修改成功！");
                                    }
                                    else if(data['result']==false){
                                        alert("修改失败！");
                                    }

                                });
                    }*/

                });
            }
        };
    }();




    <!-- EDITABLE TABLE FUNCTION  -->
    jQuery(document).ready(function() {
        EditableTable.init();
    });
    function edit(gid,gname){
        $.post("{:U('Admin/Group/getprivilege')}",
                {
                    "id":gid
                },
                function(data){
                    $('#current_group').empty();
                    $('#current_group').append("<small >正 在 编 辑</small> "+ gname +" <small>群 组</small>");

                    var select = [];
                    var deselect = [];
                    var row = 0;
                    for(var each1 in data){
                        var col = 0;
                        for(var each2 in data[each1]){
                            console.log(each1+" "+each2+"  ");
                            if(data[each1].charAt(each2) == 1){
                                var obj = {};
                                obj.text = privilege[each1][each2];
                                obj.value = ""+row+col;
                                $('#my_multi_select3').multiSelect("addOption",obj);
                                $('#my_multi_select3').multiSelect("select",""+row+col);
                            }
                            else if(data[each1].charAt(each2) == 0){
                                obj = {};
                                obj.text = privilege[each1][each2];
                                obj.value = ""+row+col;
                                $('#my_multi_select3').multiSelect("addOption",obj);
                                $('#my_multi_select3').multiSelect("deselect",""+row+col);
                            }
                            col++;
                        }
                        row++;
                    }
                }
        );
    }
</script>

</body>
</html>

