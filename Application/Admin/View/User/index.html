<!DOCTYPE html>
<html lang="en">
<head>
    <!-- BEGIN META -->

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Olive Enterprise">
    <!-- END META -->

    <!-- BEGIN SHORTCUT ICON -->
    <link rel="shortcut icon" href="__ROOT__/Public/img/favicon.ico">
    <!-- END SHORTCUT ICON -->
    <title>
        用户管理 - 普林派特ERP管理系统
    </title>

    <!-- BEGIN STYLESHEET -->

    <link href="__ROOT__/Public/css/bootstrap.min.css" rel="stylesheet"><!-- BOOTSTRAP CSS -->
    <link href="__ROOT__/Public/css/bootstrap-reset.css" rel="stylesheet"><!-- BOOTSTRAP CSS -->

    <link href="__ROOT__/Public/assets/font-awesome/css/font-awesome.css" rel="stylesheet"><!-- FONT AWESOME ICON STYLESHEET -->
    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/assets/bootstrap-wysihtml5/bootstrap-wysihtml5.css"><!-- BOOTSTRAP WYSIHTML5 PLUGIN CSS -->
    <link rel="stylesheet" href="__ROOT__/Public/assets/data-tables/DT_bootstrap.css"><!-- DATATABLE CSS -->
    <link href="__ROOT__/Public/css/style.css" rel="stylesheet"><!-- THEME BASIC CSS -->
    <link href="__ROOT__/Public/css/style-responsive.css" rel="stylesheet"><!-- THEME BASIC RESPONSIVE  CSS -->

    <!--[if lt IE 9]>
    <script src="__ROOT__/Public/js/html5shiv.js">
    </script>
    <script src="__ROOT__/Public/js/respond.min.js">
    </script>
    <![endif]-->
    <!-- END STYLESHEET -->

</head>
<body>
<!-- BEGIN SECTION -->

<section id="container" class="">
    <!-- BEGIN HEADER -->

    <include file="./Application/Common/Common/header.html" />
    <!-- END HEADER -->


    <!-- BEGIN SIDEBAR -->
    <include file="./Application/Common/Common/sidebar.html" />
    <!-- END SIDEBAR -->

    <!-- START MAIN CONTENT -->
    <section id="main-content">
        
        <section class="wrapper site-min-height">
            <!-- START ROW -->
            <div class="row">
                <div class="col-md-12">
                    <section class="panel">
                        <header class="panel-heading">
                            <span class="label label-primary">用 户</span>
                             <span class="tools pull-right">
                             <a href="javascript:;" class="fa fa-chevron-down"></a>
                             <a href="javascript:;" class="fa fa-times"></a>
                             </span>
                        </header>
                        <div class="panel-body">
                            <div class="adv-table editable-table ">
                                <div class="clearfix">
                                    <div class="btn-group">
                                        <a data-toggle="modal" data-target="#myModal" id="editable-sample_new" class="btn btn-success green" onclick="group('group1')" >
                                            增加员工 <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                    <div class="btn-group pull-right">
                                        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">工 具 <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu pull-right">
                                            <li><a href="#">Print</a></li>
                                            <li><a href="#">Save as PDF</a></li>
                                            <li><a href="#">Export to Excel</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="space15"></div>
                                <table class="table table-striped table-hover table-bordered" id="editable-sample">
                                        <thead>
                                        <tr>
                                            <th>工 号</th>
                                            <th>姓 名</th>
                                            <th>群 组</th>
                                            <th>编 辑</th>
                                            <th>删 除</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>

                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </section>
        <!-- START WRAPPER -->
    </section>
    <!-- END MAIN CONTENT -->
    <!-- BEGIN FOOTER -->

    <footer class="site-footer">
        <div class="text-center">
            2013 &copy; Olive Admin by
            <a href="" target="_blank">
                Olive Enterprise
            </a>
            <a href="http://www.mycodes.net" class="go-top">
                <i class="fa fa-angle-up">
                </i>
            </a>
        </div>
    </footer>
    <!-- END FOOTER -->



</section>
<!-- END SECTION -->

<!-- 模态框（Modal）-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    校 对 订 单
                </h4>
            </div>
            <div class="modal-body">
                <form action="#" class="form-horizontal tasi-form">
                    <div class="form-group">
                        <label class="col-md-3 control-label"> &nbsp;&nbsp;工&nbsp;号</label>
                        <div class="col-md-6 col-xs-11">
                            <input id="uId" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label"> &nbsp;&nbsp;姓&nbsp;名</label>
                        <div class="col-md-6 col-xs-11">
                            <input id="uName" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label"> &nbsp;&nbsp;群&nbsp;组</label>
                        <div class="col-md-6 col-xs-11">
                            <select class="form-control" id="group1">

                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="close" type="button" class="btn btn-default"
                        data-dismiss="modal">关 闭
                </button>
                <button onclick='add()' type="button" class="btn btn-primary">
                    提 交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- BEGIN JS -->
<script src="__ROOT__/Public/js/jquery-1.8.3.min.js" ></script><!-- BASIC JS LIABRARY 1.8.3 -->
<script src="__ROOT__/Public/js/bootstrap.min.js" ></script><!-- BOOTSTRAP JS  -->
<script src="__ROOT__/Public/js/jquery.dcjqaccordion.2.7.js"></script><!-- ACCORDING JS -->
<script src="__ROOT__/Public/js/jquery.scrollTo.min.js" ></script><!-- SCROLLTO JS  -->
<script src="__ROOT__/Public/js/jquery.nicescroll.js" > </script><!-- NICESCROLL JS  -->
<script src="__ROOT__/Public/js/respond.min.js" ></script><!-- RESPOND JS  -->
<script src="__ROOT__/Public/assets/advanced-datatable/media/js/jquery.dataTables.js"></script><!-- DATATABLE JS  -->
<script src="__ROOT__/Public/assets/data-tables/DT_bootstrap.js"></script><!-- DATATABLE JS  -->
<script src="__ROOT__/Public/js/common-scripts.js" ></script><!-- BASIC COMMON JS  -->
<!-- END JS -->
<script>
    $("#admin_module").addClass("active");
    $("#user_manage").addClass("active");
    //获取群组
    function group(group,select){
        if(select==undefined){
            $('#uId').val("");
            $('#uName').val("");
        }
        $.post("{:U('admin/group/getGroup')}",{

        },function(data){
            if(select!=undefined){
                $("#"+group).empty();
                for(var key in data) {
                    if(select==key){
                        $("#"+group).append("<option value='"+key+"' selected='selected'>"+key+"  &nbsp;"+data[key]+"</option>>");
                    }
                    else{
                        $("#"+group).append("<option value='"+key+"'>"+key+"  &nbsp;"+data[key]+"</option>>");
                    }
                }
            }
            else{
                $("#"+group).empty();
                for(var key in data){
                    $("#"+group).append("<option value='"+key+"'>"+key+"  &nbsp;"+data[key]+"</option>>");
                }
            }


        });
    }

    //增加用户
    function add(){
        $.post("{:U('admin/user/add')}",{
            uId: $('#uId').val(),
            uName: $('#uName').val(),
            gId: $('#group1').val()
        },
        function(data){
            if(data['result'] == true){
                $('#editable-sample').dataTable().fnAddData({
                    uId: $('#uId').val(),
                    uName: $('#uName').val(),
                    gId: $('#group1').val(),
                    update: '<a class="edit" href="">编 辑</a>',
                    delete: '<a class="cancel" data-mode="new" href="">取 消</a>'
                },false);
                $('#close').click();
                alert("增加成功！");
            }else{
                alert("增加失败 ！");
            }
        });
    }

    var EditableTable = function () {

        'use strict';

        return {
            init: function () {
                function restoreRow(oTable, nRow) {
                    var aData = oTable.fnGetData(nRow);
                    var jqTds = $('>td', nRow);
                    oTable.fnUpdate(aData['uId'], nRow, 0, false, true);
                    oTable.fnUpdate(aData['uName'], nRow, 1, false, true);
                    oTable.fnUpdate(aData['gId'], nRow, 2, false, true);
                    oTable.fnUpdate(aData['update'], nRow, 3, false, true);
                    oTable.fnUpdate(aData['delete'], nRow, 4, false, true);

                    //oTable.fnDraw();
                }

                function editRow(oTable, nRow) {
                    var aData = oTable.fnGetData(nRow);
                    var jqTds = $('>td', nRow);
                    jqTds[0].innerHTML = '<input type="text" class="form-control small" value="' + aData['uId'] + '" disabled>';
                    jqTds[1].innerHTML = '<input type="text" class="form-control small" value="' + aData['uName'] + '">';
                    jqTds[2].innerHTML = ' <select class="form-control" id="group2" ></select>';
                    jqTds[3].innerHTML = '<a class="save" href=""><span class="label label-primary">保 存</span></a>';
                    jqTds[4].innerHTML = '<a class="cancel" href=""><span class="label label-info">取 消</span></a>';

                    group("group2",aData['gId']);
                }

                var oTable = $('#editable-sample').dataTable({
                    autoWidth : false,
                    bServerSide: true,
                    "ajax": {
                        "url":"{:U('admin/user/getUser')}"
                    },
                    "searching": true,
                    columns: [
                        { "data": "uId", "orderable":false},
                        { "data": "uName", "orderable":false},
                       /* { "data": "uTel", "orderable":false },*/
                        { "data": "gId", "orderable":false },
                        { "data": "update", "orderable":false},
                        { "data": "delete", "orderable":false}
                    ],
                    "aLengthMenu": [
                        [5, 15, 20, -1],
                        [5, 15, 20, "All"]
                    ],
                    "iDisplayLength": 5,
                    "sDom": "<'row'<'col-lg-6'l><'col-lg-6'f>r><'table-responsive' t><'row'<'col-lg-6'i><'col-lg-6'p>>",
                    "sPaginationType": "bootstrap",
                    "oLanguage": {
                        "sProcessing": "正在加载中......",
                        "sLengthMenu": "每页显示 _MENU_ 条记录",
                        "sZeroRecords": "对不起，查询不到相关数据！",
                        "sEmptyTable": "表中无数据存在！",
                        "sInfo": "当前显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
                        "sInfoFiltered": "数据表中共为 _MAX_ 条记录",
                        "sSearch": "搜索",
                        "oPaginate": {
                            "sFirst": "首页",
                            "sPrevious": "上一页",
                            "sNext": "下一页",
                            "sLast": "末页"
                        }
                    },
                    "aoColumnDefs": [{
                        'bSortable': true,
                        'aTargets': [0]
                    }]
                });
                jQuery('#editable-sample_wrapper .dataTables_filter input').addClass("form-control medium");
                jQuery('#editable-sample_wrapper .dataTables_length select').addClass("form-control xsmall");
                var nEditing = null;
                $('#editable-sample a.delete').live('click', function (e) {
                    e.preventDefault();
                    if (confirm("你确定要删除这条记录?") == false) {
                        return;
                    }
                    var nRow = $(this).parents('tr')[0];
                    var jqInputs = $('td',nRow);
                    $.post("{:U('admin/user/delete')}",{
                                uId :jqInputs[0].innerHTML
                            },
                            function(data){
                                if(data['result']==1){
                                    alert("删除成功！");
                                    oTable.fnDeleteRow(nRow);
                                }
                                else if(data['result']==0){
                                    alert("删除失败！");
                                }
                            })
                });
                $('#editable-sample a.cancel').live('click', function (e) {
                    e.preventDefault();
                    if ($(this).attr("data-mode") == "new") {
                        var nRow = $(this).parents('tr')[0];
                        oTable.fnDeleteRow(nRow);
                    } else {
                        restoreRow(oTable, nEditing);
                        nEditing = null;

                    }
                });
                $('#editable-sample a.edit').live('click', function (e) {
                    e.preventDefault();
                    var nRow = $(this).parents('tr')[0];
                    if (nEditing !== null && nEditing != nRow) {
                        restoreRow(oTable, nEditing);
                        editRow(oTable, nRow);
                        nEditing = nRow;
                    } else {
                        editRow(oTable, nRow);
                        nEditing = nRow;
                    }
                });
                $('#editable-sample a.save').live('click', function (e) {
                    e.preventDefault();
                    var nRow = $(this).parents('tr')[0];
                    var jqInputs = $('input', nRow);
                        //修改
                        $.post("{:U('admin/user/update')}",{
                                    uId: jqInputs[0].value,
                                    uName: jqInputs[1].value,
                                    gId: jqInputs[2].value
                                },
                                function(data){
                                    if(data['result']==true){
                                        nEditing = nRow;
                                        oTable.fnUpdate(jqInputs[0].value, nRow, 0, false);
                                        oTable.fnUpdate(jqInputs[1].value, nRow, 1, false);
                                        restoreRow(oTable, nEditing);
                                        nEditing = null;
                                        alert("修改成功！");
                                    }
                                    else if(data['result']==false){
                                        alert("修改失败！");
                                    }

                                });
                });
            }
        };
    }();




    <!-- EDITABLE TABLE FUNCTION  -->
    jQuery(document).ready(function() {
        EditableTable.init();
    });
    function edit(gid,gname){
        $.post("{:U('Admin/Group/getprivilege')}",
                {
                    "id":gid
                },
                function(data){
                    $('#current_group').empty();
                    $('#current_group').append("<small >正 在 编 辑</small> "+ gname +" <small>群 组</small>");

                    var select = [];
                    var deselect = [];
                    for(pri in data){
                        if(data[pri] == 1){
                            var obj = {};
                            obj.text = privilege[pri];
                            obj.value = pri;
                            select.push(obj);
                            $('#my_multi_select3').multiSelect("addOption",obj);
                            $('#my_multi_select3').multiSelect("select",pri);
                        }
                        else if(data[pri] == 0){
                            obj = {};
                            obj.text = privilege[pri];
                            obj.value = pri;
                            deselect.push(obj);
                            $('#my_multi_select3').multiSelect("addOption",obj);
                            $('#my_multi_select3').multiSelect("deselect",pri);
                        }
                    }

                }
        );
    }
</script>

</body>
</html>

